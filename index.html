<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تطبيق تتبع المسح اللوجستي</title>
    <link rel="manifest" href="manifest.json">
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
        .container { max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        input, button { width: 100%; padding: 10px; margin: 10px 0; border: 1px solid #ccc; border-radius: 4px; }
        #scanner { display: none; height: 300px; }
        #history { margin-top: 20px; }
        .scan-item { padding: 10px; border-bottom: 1px solid #eee; }
        .status-success { color: green; }
        .status-pending { color: orange; }
        .error { color: red; }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>تتبع عمليات المسح</h1>
        <input type="text" id="blId" placeholder="معرّف إشعار التسليم (BL ID)" required>
        <input type="text" id="productId" placeholder="معرّف المنتج (Product ID)" required>
        <input type="text" id="scanInput" placeholder="مسح الرمز (Barcode أو QR)" autofocus>
        <button id="startCamera">بدء المسح بالكاميرا</button>
        <div id="scanner"></div>
        <div id="message" class="error"></div>
        
        <h2>سجل المسح</h2>
        <input type="text" id="searchHistory" placeholder="بحث حسب BL ID أو Product ID أو الرمز">
        <div id="history"></div>
    </div>

    <script>
        const blIdInput = document.getElementById('blId');
        const productIdInput = document.getElementById('productId');
        const scanInput = document.getElementById('scanInput');
        const startCameraBtn = document.getElementById('startCamera');
        const scannerDiv = document.getElementById('scanner');
        const messageDiv = document.getElementById('message');
        const historyDiv = document.getElementById('history');
        const searchHistoryInput = document.getElementById('searchHistory');

        let html5QrCode;
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby88RlBlIqowHdSxX_px50mZAe9A1WB9DU8M_37LQ2OH1mT99op_ZMLjg0lWScBfw_qvA/exec'; // استبدل بـ URL الخاص بك

        // تحميل السجل من localStorage
        let scans = JSON.parse(localStorage.getItem('scans')) || [];
        renderHistory();

        // دعم USB Scanner (كإدخال نصي)
        scanInput.addEventListener('input', (e) => {
            if (e.target.value.length > 0) {
                processScan(e.target.value);
                e.target.value = ''; // إعادة تهيئة
            }
        });

        // بدء المسح بالكاميرا
        startCameraBtn.addEventListener('click', () => {
            scannerDiv.style.display = 'block';
            html5QrCode = new Html5Qrcode("scanner");
            html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: 250 }, (decodedText) => {
                processScan(decodedText);
            }, (error) => console.warn(error));
        });

        // معالجة المسح
        function processScan(code) {
            const blId = blIdInput.value.trim();
            const productId = productIdInput.value.trim();
            if (!blId || !productId) {
                messageDiv.textContent = 'يرجى إدخال BL ID و Product ID.';
                return;
            }

            // التحقق من التكرار
            if (scans.some(s => s.blId === blId && s.productId === productId && s.code === code)) {
                messageDiv.textContent = 'هذا الرمز مكرر لنفس المنتج في هذا الإشعار.';
                return;
            }

            const scan = {
                date: new Date().toLocaleDateString('ar'),
                time: new Date().toLocaleTimeString('ar'),
                blId,
                productId,
                code,
                status: 'pending' // بانتظار الإرسال
            };

            scans.push(scan);
            localStorage.setItem('scans', JSON.stringify(scans));
            renderHistory();
            messageDiv.textContent = '';
            sendToServer(scan); // محاولة الإرسال
            productIdInput.focus(); // التركيز على تغيير المنتج
        }

        // إرسال إلى الخادم
        async function sendToServer(scan) {
            if (!navigator.onLine) return;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify(scan)
                });
                if (response.ok) {
                    scan.status = 'success';
                    updateLocalStorage();
                    renderHistory();
                }
            } catch (error) {
                console.error(error);
            }
        }

        // إرسال المعلقة عند الاتصال
        window.addEventListener('online', () => {
            scans.filter(s => s.status === 'pending').forEach(sendToServer);
        });

        // عرض السجل
        function renderHistory() {
            historyDiv.innerHTML = '';
            const search = searchHistoryInput.value.toLowerCase();
            scans.filter(s => 
                s.blId.toLowerCase().includes(search) ||
                s.productId.toLowerCase().includes(search) ||
                s.code.toLowerCase().includes(search)
            ).forEach(s => {
                const div = document.createElement('div');
                div.className = 'scan-item';
                div.innerHTML = `${s.date} ${s.time} - BL: ${s.blId} - Prod: ${s.productId} - Code: ${s.code} <span class="${s.status === 'success' ? 'status-success' : 'status-pending'}">${s.status === 'success' ? 'تم الإرسال' : 'محفوظ محلياً'}</span>`;
                historyDiv.appendChild(div);
            });
        }

        // تحديث localStorage
        function updateLocalStorage() {
            localStorage.setItem('scans', JSON.stringify(scans));
        }

        // بحث في السجل
        searchHistoryInput.addEventListener('input', renderHistory);

        // دعم PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js');
        }
    </script>
</body>
</html>
