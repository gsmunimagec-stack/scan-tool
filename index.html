<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Advanced Scan Tool</title>

  <!-- Ù…ÙƒØªØ¨Ø© html5-qrcode -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; padding:20px; }
    input, button { width:100%; padding:12px; margin:6px 0; font-size:16px; box-sizing:border-box; }
    button { background:#1976d2; color:white; border:none; cursor:pointer; }
    button:disabled { background:#90a4ae; cursor:not-allowed; }
    #reader { width:100%; max-width:400px; margin:10px auto; }
    #status { margin-top:10px; font-weight:bold; min-height:24px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    td, th { border:1px solid #ccc; padding:6px; font-size:14px; text-align:left; }
    h2, h3 { margin-top:10px; }
  </style>
</head>

<body>

  <h2>ğŸ“¦ Scan Tool AvancÃ©</h2>

  <input id="bl_id" placeholder="ID Bon de Livraison">
  <input id="produit_id" placeholder="ID Produit">
  <input id="scan_input" placeholder="Scan (Douchette)">
  <button id="btn_send" onclick="sendScan()">Envoyer Scan</button>

  <h3>ğŸ“· Scan par CamÃ©ra</h3>
  <div id="reader"></div>

  <div id="status"></div>

  <h3>ğŸ“œ Historique (Local)</h3>
  <input id="search" placeholder="Recherche (Code / Produit / BL)" onkeyup="renderHistory()">
  <table>
    <thead>
      <tr>
        <th>Date</th><th>BL</th><th>Produit</th><th>Code</th><th>Status</th>
      </tr>
    </thead>
    <tbody id="history"></tbody>
  </table>

  <script>
    // Ø¶Ø¹ Ù‡Ù†Ø§ Ø±Ø§Ø¨Ø· Web App Ù…Ù† Google Apps Script
    const API_URL = "PASTE_YOUR_WEB_APP_URL_HERE";

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
    let localData;
    try {
      localData = JSON.parse(localStorage.getItem("scans")) || [];
    } catch (e) {
      localData = [];
    }

    function saveLocal(data) {
      localData.push(data);
      localStorage.setItem("scans", JSON.stringify(localData));
    }

    function isDuplicate(bl, produit, code) {
      return localData.some(s =>
        s.bl_id === bl &&
        s.produit_id === produit &&
        s.code_scanned === code
      );
    }

    function sendScan(codeFromCamera = null) {
      const blInput = document.getElementById("bl_id");
      const produitInput = document.getElementById("produit_id");
      const scanInput = document.getElementById("scan_input");
      const statusEl = document.getElementById("status");

      const bl = blInput.value.trim();
      const produit = produitInput.value.trim();
      const code = (codeFromCamera || scanInput.value).trim();

      if (!bl || !produit || !code) {
        alert("Ø¹Ù…Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø§Ù†Ø§Øª: BL, Produit, Code");
        return;
      }

      if (isDuplicate(bl, produit, code)) {
        statusEl.innerText = "âš ï¸ Code Ù…ÙƒØ±Ø± Ù„Ù†ÙØ³ BL Ùˆ Produit";
        return;
      }

      const payload = {
        bl_id: bl,
        produit_id: produit,
        code_scanned: code,
        date: new Date().toISOString(),
        sent: false
      };

      saveLocal(payload);
      scanInput.value = "";
      statusEl.innerText = "ğŸ’¾ Scan Ù…Ø­ÙÙˆØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹";

      sendPending();
      renderHistory();
    }

    function sendPending() {
      if (!navigator.onLine) return;

      const statusEl = document.getElementById("status");

      localData.forEach((item) => {
        if (!item.sent) {
          fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(item)
          })
          .then(res => res.text())
          .then(txt => {
            console.log("Response:", txt);
            item.sent = true;
            localStorage.setItem("scans", JSON.stringify(localData));
            statusEl.innerText = "âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Google Sheets";
            renderHistory();
          })
          .catch(err => {
            console.error("Fetch error:", err);
            statusEl.innerText = "â³ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª";
          });
        }
      });
    }

    window.addEventListener("online", sendPending);

    function renderHistory() {
      const searchInput = document.getElementById("search");
      const historyTbody = document.getElementById("history");
      const q = (searchInput.value || "").toLowerCase();

      historyTbody.innerHTML = "";

      localData
        .filter(s =>
          s.code_scanned.toLowerCase().includes(q) ||
          s.produit_id.toLowerCase().includes(q) ||
          s.bl_id.toLowerCase().includes(q)
        )
        .forEach(s => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${new Date(s.date).toLocaleString()}</td>
            <td>${s.bl_id}</td>
            <td>${s.produit_id}</td>
            <td>${s.code_scanned}</td>
            <td>${s.sent ? "âœ… EnvoyÃ©" : "â³ Offline"}</td>
          `;
          historyTbody.appendChild(tr);
        });
    }

    document.getElementById("scan_input").addEventListener("keypress", e => {
      if (e.key === "Enter") sendScan();
    });

    // ===== Ø¥Ø¹Ø¯Ø§Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ QR Ø¨Ø§Ø³ØªØ¹Ù…Ø§Ù„ Html5QrcodeScanner =====
    function onScanSuccess(decodedText, decodedResult) {
      // ÙƒÙ„Ù…Ø§ ÙŠØªÙ… Ø³ÙƒØ§Ù† ÙƒÙˆØ¯ØŒ ÙŠØªÙ… Ø­ÙØ¸Ù‡ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
      sendScan(decodedText);
    }

    function onScanFailure(error) {
      // Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…ØªÙƒØ±Ø±Ø© ÙŠÙ…ÙƒÙ† ØªØ¬Ø§Ù‡Ù„Ù‡Ø§
      // console.warn(`QR error = ${error}`);
    }

    let html5QrcodeScanner = new Html5QrcodeScanner(
      "reader",
      { fps: 10, qrbox: 250 },
      false
    );
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);

    // Ø£ÙˆÙ„ Ø¹Ø±Ø¶ Ù„Ù„ØªØ§Ø±ÙŠØ®
    renderHistory();
  </script>
</body>
</html>

